name: EAS Build Android

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'frontend/**'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'frontend/**'
  workflow_dispatch:  # Manuel tetikleme

jobs:
  build:
    name: EAS Build Android APK
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Configure EAS Project
        run: eas project:init --non-interactive --force || true
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Run Expo Prebuild
        run: |
          echo "Running expo prebuild to generate native projects..."
          npx expo prebuild --platform android --clean || true
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Generate Android Keystore
        run: |
          echo "Generating Android debug keystore..."
          mkdir -p android/app
          # Android debug keystore oluÅŸtur
          keytool -genkeypair \
            -v \
            -storetype PKCS12 \
            -keystore android/app/debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass android \
            -keypass android \
            -dname "CN=Android Debug,O=Android,C=US"
          echo "Keystore created successfully"
        continue-on-error: true

      - name: Setup Android Credentials
        run: |
          echo "Configuring EAS to use generated keystore..."
          # credentials.json oluÅŸtur
          cat > credentials.json << 'EOF'
          {
            "android": {
              "keystore": {
                "keystorePath": "android/app/debug.keystore",
                "keystorePassword": "android",
                "keyAlias": "androiddebugkey",
                "keyPassword": "android"
              }
            }
          }
          EOF
          cat credentials.json
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: EAS Build
        run: eas build --platform android --profile preview --non-interactive --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_BUILD_AUTOSUBMIT: "1"
          EXPO_USE_DEV_SERVER: "0"

      - name: Build Info
        run: |
          echo "### EAS Build Started! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build has been queued on EAS servers." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check build status at: https://expo.dev" >> $GITHUB_STEP_SUMMARY
          echo "2. Build will be available for download once completed" >> $GITHUB_STEP_SUMMARY
          echo "3. You'll receive notifications via email" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** preview (APK)" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** Android" >> $GITHUB_STEP_SUMMARY
